---
- hosts: all
  tasks:
    - name: Create docker images # noqa 301
      command: "make -k"
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Launch docker-compose to test docker images # noqa 301
      command: "docker-compose up -d"
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Get Consul services # noqa 301
      command: "docker-compose exec -T consul_server consul catalog services"
      args:
        chdir: "{{ zuul.project.src_dir }}"
      register: result
      until: result.rc == 0
      retries: 6
      delay: 10

    - name: Check that RabbitMQ is listed in Consul services # noqa 301
      shell: |
        set -o pipefail
        docker-compose exec -T consul_server consul catalog services|grep rabbitmq
      args:
        chdir: "{{ zuul.project.src_dir }}"
        executable: /bin/bash
      register: result
      until: result.rc == 0
      retries: 6
      delay: 10

    - name: Stop containers started by docker-compose # noqa 301
      command: "docker-compose down"
      args:
        chdir: "{{ zuul.project.src_dir }}"

    - name: Launch the C4 containers # noqa 301
      command: "docker-compose -f docker-compose.yaml up -d"
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-c4"

#     - name: Check that services are listed in Consul services # noqa 301
#       shell: |
#         set -o pipefail
#         docker-compose exec -T consul consul catalog services|grep '^{{ item }}$'
#       args:
#         chdir: "{{ zuul.project.src_dir }}/../wazo-c4"
#         executable: /bin/bash
#       register: results
#       until: results[-1].rc == 0
#       retries: 6
#       delay: 10
#       with_items:
#         - sbc
#         - router
#         - wazo-router-confd
#         - rtp

    - name: Check that sbc is listed in Consul services # noqa 301
      shell: |
        set -o pipefail
        docker-compose exec -T consul consul catalog services|grep '^sbc$'
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-c4"
        executable: /bin/bash
      register: result_sbc
      until: result_sbc.rc == 0
      retries: 6
      delay: 10

    - name: Check that router is listed in Consul services # noqa 301
      shell: |
        set -o pipefail
        "docker-compose exec -T consul consul catalog services|grep '^router$'"
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-c4"
        executable: /bin/bash
      register: result_router
      until: result_router.rc == 0
      retries: 6
      delay: 10

    - name: Check that wazo-router-confd is listed in Consul services # noqa 301
      shell: |
        set -o pipefail
        docker-compose exec -T consul consul catalog services|grep '^wazo-router-confd$'
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-c4"
        executable: /bin/bash
      register: result_confd
      until: result_confd.rc == 0
      retries: 6
      delay: 10

    - name: Check that rtp is listed in Consul services # noqa 301
      shell: |
        set -o pipefail
        docker-compose exec -T consul consul catalog services|grep '^rtp$'
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-c4"
        executable: /bin/bash
      register: result_rtp
      until: result_rtp.rc == 0
      retries: 6
      delay: 10

    - name: List Consul services # noqa 301
      command: "docker-compose exec -T consul consul catalog services"
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-c4"

    - name: Run tests # noqa 301
      command: "docker-compose exec -T wazo-tester pytest /tests/"
      args:
        chdir: "{{ zuul.project.src_dir }}/../wazo-c4"
