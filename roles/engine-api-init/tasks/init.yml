- name: Assert Debian Stretch
  assert:
    that: ansible_distribution == 'Debian' and ansible_distribution_major_version == '9'

- name: Copy wazo-auth database preconfiguration
  template:
    src: templates/wazo-auth.cfg.j2
    dest: /tmp/wazo-auth.cfg

- name: Reconfigure database options for wazo-auth package
  command: debconf-set-selections /tmp/wazo-auth.cfg

- name: Initialize wazo-auth database
  command: dpkg-reconfigure wazo-auth --frontend noninteractive

- name: Install wazo-auth-keys
  apt:
    name: wazo-auth-keys
    state: latest

- name: Create service users with wazo-auth-keys
  command: wazo-auth-keys service update

- name: Copy main database preconfiguration
  template:
    src: templates/xivo-manage-db.cfg.j2
    dest: /tmp/xivo-manage-db.cfg

- name: Apply main database preconfiguration
  command: debconf-set-selections /tmp/xivo-manage-db.cfg

- name: Initialize main database
  command: dpkg-reconfigure xivo-manage-db --frontend noninteractive

- name: Fix Twisted dropin.cache
  command: twistd --help-reactors

- name: Start Wazo services
  service:
    name: "{{ item }}"
    state: restarted
  loop:
    - xivo-agid
    - xivo-amid
    - wazo-confd
    - xivo-confgend
    - wazo-calld
    - xivo-provd
    - wazo-websocketd

- name: Finalize engine configuration
  block:
  - name: Setup engine
    uri:
      url: "https://{{ engine_api_host}}:{{ engine_api_port}}{{ engine_setupd_path }}/setup"
      method: POST
      timeout: 300
      validate_certs: no
      body_format: json
      body:
        engine_internal_address: "{{ engine_api_host }}"
        engine_language: "{{ engine_language }}"
        engine_license: true
        engine_password: "{{ engine_api_root_password }}"
      status_code: 201
  
  - name: Create tenant
    command: "wazo-auth-cli tenant create {{ tenant_name }}"
  
  - name: Create API client
    command: "wazo-auth-cli user create {{ api_client_name}} --tenant {{ tenant_name }} --password {{ api_client_password }} --purpose external_api"
  
  - name: Create policy
    command: "wazo-auth-cli policy create api-client-policy --tenant {{ tenant_name }} --acl 'confd.#'"
  
  - name: Enable policy for API client
    command: "wazo-auth-cli user add {{ api_client_name}} --policy api-client-policy"
  when: engine_api_configure_wizard == "true"
